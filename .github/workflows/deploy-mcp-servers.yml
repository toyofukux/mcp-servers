name: Deploy MCP Servers to Google Cloud Run

on:
  push:
    branches:
      - main

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check required global secrets
        id: check-global-secrets
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: |
          missing_secrets=""

          if [[ -z "$GCP_CREDENTIALS" ]]; then
            missing_secrets="${missing_secrets} GCP_CREDENTIALS"
          fi

          if [[ -z "$GCP_REGION" ]]; then
            missing_secrets="${missing_secrets} GCP_REGION"
          fi

          if [[ ! -z "$missing_secrets" ]]; then
            echo "::error::Missing required global secrets:${missing_secrets}"
            echo "::error::Please set up the required secrets in your GitHub repository settings."
            echo "::error::See docs/github-secrets-setup.md for detailed instructions."
            exit 1
          else
            echo "All required global secrets are available"
          fi

  deploy:
    needs: validate-secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 最新のコミットのみ取得

      - id: "auth"
        name: "Google Cloud認証"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"

      - name: "Set up Google Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "必要なAPIを有効化"
        run: |
          # Container Registry APIを有効化
          gcloud services enable containerregistry.googleapis.com
          # Cloud Run APIを有効化
          gcloud services enable run.googleapis.com

      - name: "Dockerの認証設定"
        run: |
          gcloud auth configure-docker

      - name: Get GitHub MCP server version
        id: github-version
        run: |
          if [[ ! -f mcps/github/version.txt ]]; then
            echo "::error::GitHub MCPサーバーのバージョンファイルが見つかりません: mcps/github/version.txt"
            exit 1
          fi
          VERSION=$(cat mcps/github/version.txt)
          if [[ -z "$VERSION" ]]; then
            echo "::error::GitHub MCPサーバーのバージョンが空です: mcps/github/version.txt"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "GitHub MCPサーバーバージョン: $VERSION"

      - name: Check GitHub secrets
        env:
          GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
        run: |
          if [[ -z "$GH_PERSONAL_ACCESS_TOKEN" ]]; then
            echo "::error::Missing required secret for GitHub MCP server: GH_PERSONAL_ACCESS_TOKEN"
            echo "::error::Please set up this secret in your GitHub repository settings."
            echo "::error::See docs/github-secrets-setup.md for detailed instructions."
            exit 1
          fi

      - name: Get Notion MCP server version
        id: notion-version
        run: |
          if [[ ! -f mcps/notion/version.txt ]]; then
            echo "::error::Notion MCPサーバーのバージョンファイルが見つかりません: mcps/notion/version.txt"
            exit 1
          fi
          VERSION=$(cat mcps/notion/version.txt)
          if [[ -z "$VERSION" ]]; then
            echo "::error::Notion MCPサーバーのバージョンが空です: mcps/notion/version.txt"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Notion MCPサーバーバージョン: $VERSION"

      - name: Check Notion secrets
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
        run: |
          if [[ -z "$NOTION_API_TOKEN" ]]; then
            echo "::error::Missing required secret for Notion MCP server: NOTION_API_TOKEN"
            echo "::error::Please set up this secret in your GitHub repository settings."
            echo "::error::See docs/github-secrets-setup.md for detailed instructions."
            exit 1
          fi

      - name: Deploy GitHub MCP Server
        env:
          VERSION: ${{ steps.github-version.outputs.version }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "-------------------------------------"
          echo "Deploying GitHub MCP server"
          echo "Version: ${{ steps.github-version.outputs.version }}"

          # Double-check required secrets before deployment
          if [[ -z "$VERSION" ]]; then
            echo "❌ Deployment failed: Missing required secret GH_PERSONAL_ACCESS_TOKEN"
            exit 1
          fi

          # イメージ情報を取得
          IMAGE=$(cat mcps/github/docker-image.txt)
          SOURCE_IMAGE="${IMAGE}:${VERSION}"

          # GCRイメージ情報を設定
          PROJECT_ID=$(gcloud config get-value project)
          GCR_IMAGE="gcr.io/${PROJECT_ID}/github-mcp-server:${VERSION}"

          # GCRにイメージが存在するか確認
          if gcloud container images list-tags gcr.io/${PROJECT_ID}/github-mcp-server --filter="tags=${VERSION}" --format="get(tags)" | grep -q "${VERSION}"; then
            echo "イメージ ${GCR_IMAGE} は既にGCRに存在します。プッシュをスキップします。"
          else
            echo "Copying image from $SOURCE_IMAGE to $GCR_IMAGE"
            # イメージをプルしてGCRにプッシュ
            docker pull $SOURCE_IMAGE
            docker tag $SOURCE_IMAGE $GCR_IMAGE
            docker push $GCR_IMAGE
          fi

          # デプロイに使用するイメージを設定
          DEPLOY_IMAGE=$GCR_IMAGE
          echo "Using GCR image: $DEPLOY_IMAGE"

          # サービス名設定
          SERVICE_NAME="mcp-github"
          echo "Service name: $SERVICE_NAME"

          # Cloud Runにデプロイ
          echo "Deploying to Cloud Run..."
          gcloud run deploy $SERVICE_NAME \
            --image $DEPLOY_IMAGE \
            --platform managed \
            --region $GCP_REGION \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 1 \
            --cpu 1 \
            --port 8080 \
            --timeout 3600 \
            --no-allow-unauthenticated \
            --set-env-vars="GITHUB_PERSONAL_ACCESS_TOKEN=$GH_PERSONAL_ACCESS_TOKEN"

          if [ $? -eq 0 ]; then
            echo "✅ Successfully deployed $SERVICE_NAME"
            SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --platform managed --region $GCP_REGION --format="value(status.url)")
            echo "Service URL: $SERVICE_URL"
          else
            echo "❌ Failed to deploy $SERVICE_NAME"
            exit 1
          fi
          echo "-------------------------------------"

      - name: Deploy Notion MCP Server
        env:
          VERSION: ${{ steps.notion-version.outputs.version }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
        run: |
          echo "-------------------------------------"
          echo "Deploying Notion MCP server"
          echo "Version: ${{ steps.notion-version.outputs.version }}"

          # Double-check required secrets before deployment
          if [[ -z "$NOTION_API_TOKEN" ]]; then
            echo "❌ Deployment failed: Missing required secret NOTION_API_TOKEN"
            exit 1
          fi

          # イメージ情報を取得
          IMAGE=$(cat mcps/notion/docker-image.txt)
          SOURCE_IMAGE="${IMAGE}:${VERSION}"

          # GCRイメージ情報を設定
          PROJECT_ID=$(gcloud config get-value project)
          GCR_IMAGE="gcr.io/${PROJECT_ID}/notion-mcp-server:${VERSION}"

          # GCRにイメージが存在するか確認
          if gcloud container images list-tags gcr.io/${PROJECT_ID}/notion-mcp-server --filter="tags=${VERSION}" --format="get(tags)" | grep -q "${VERSION}"; then
            echo "イメージ ${GCR_IMAGE} は既にGCRに存在します。プッシュをスキップします。"
          else
            echo "Copying image from $SOURCE_IMAGE to $GCR_IMAGE"
            # イメージをプルしてGCRにプッシュ
            docker pull $SOURCE_IMAGE
            docker tag $SOURCE_IMAGE $GCR_IMAGE
            docker push $GCR_IMAGE
          fi

          # デプロイに使用するイメージを設定
          DEPLOY_IMAGE=$GCR_IMAGE
          echo "Using GCR image: $DEPLOY_IMAGE"

          # サービス名設定
          SERVICE_NAME="mcp-notion"
          echo "Service name: $SERVICE_NAME"

          # Cloud Runにデプロイ
          echo "Deploying to Cloud Run..."
          # NotionヘッダーJSONフォーマット
          NOTION_HEADERS="{\"Authorization\":\"Bearer $NOTION_API_TOKEN\",\"Notion-Version\":\"2022-06-28\"}"

          gcloud run deploy $SERVICE_NAME \
            --image $DEPLOY_IMAGE \
            --platform managed \
            --region $GCP_REGION \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 1 \
            --cpu 1 \
            --port 8080 \
            --timeout 3600 \
            --no-allow-unauthenticated \
            --set-env-vars="OPENAPI_MCP_HEADERS=$NOTION_HEADERS"

          if [ $? -eq 0 ]; then
            echo "✅ Successfully deployed $SERVICE_NAME"
            SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --platform managed --region $GCP_REGION --format="value(status.url)")
            echo "Service URL: $SERVICE_URL"
          else
            echo "❌ Failed to deploy $SERVICE_NAME"
            exit 1
          fi
          echo "-------------------------------------"

      # 注：新しいMCPサーバーを追加する場合は、上記と同様の形式でステップを追加してください
      # 各MCPサーバーは必要な環境変数やシークレットが異なるため、個別に設定が必要です
